# What’s New In Python 3.11

- <https://docs.python.org/3.14/whatsnew/3.11.html>

> Python 3.11 is between 10-60% faster than Python 3.10. On average, we measured a 1.25x speedup on the standard benchmark suite. See Faster CPython for details.

## Important

### PEP 678: Exceptions can be enriched with notes

通过`add_note` 方法为`BaseEexception`添加上下文相关的注释.

```python
try:
    raise TypeError('bad type')
except Exception as e:
    e.add_note('Add some information')
    raise
```

## Nice

### PEP 657: Fine-grained error locations in tracebacks

异常打印显示的错误颗粒度更细了

<details>
<summary>Example</summary>

```python
Traceback (most recent call last):
  File "distance.py", line 11, in <module>
    print(manhattan_distance(p1, p2))
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "distance.py", line 6, in manhattan_distance
    return abs(point_1.x - point_2.x) + abs(point_1.y - point_2.y)
                           ^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'x'
```

</details>

### Type Hints

#### PEP 646: Variadic generics

`可变参数泛型`注解, 允许定义泛型类接受任意数量和类型的类型参数

<details>
<summary>Example</summary>

```python
from typing import Generic, TypeVar, TypeVarTuple

Ts = TypeVarTuple('Ts')

class Array(Generic[*Ts]):
    def __init__(self, *values: *Ts):
        self.values = values

    def add_dimension(self, value) -> 'Array[*Ts, type(value)]':
        return Array(*self.values, value)

a = Array[int, str](1, 'foo')
print(a.values)  # (1, 'foo')

b = a.add_dimension(3.14)
print(b.values)  # (1, 'foo', 3.14)
```

</details>

#### PEP 655: Marking individual TypedDict items as required or not-required

允许在 `TypedDict` 中单独为key 标记必需或可选

<details>
<summary>Example</summary>

```python
from typing import TypedDict, NotRequired, Required

class Movie(TypedDict):
    title: Required[str]
    director: NotRequired[str]
    year: Required[int]
    rating: NotRequired[float]

movie1: Movie = {
    "title": "Inception",
    "year": 2010,
    # "director" 和 "rating" 可以省略
}

movie2: Movie = {
    "title": "The Matrix",
    "director": "The Wachowskis",
    "year": 1999,
    "rating": 8.7,
}
```

</details>

#### PEP 673: Self type

使用 `typing.Self` 注解返回值为该类的实例

<details>
<summary>Example</summary>

```python
class MyLock:
    def __enter__(self) -> Self:
        self.lock()
        return self

    ...

class MyInt:
    @classmethod
    def fromhex(cls, s: str) -> Self:
        return cls(int(s, 16))

    ...
```

</details>

#### PEP 675: Arbitrary literal string type

`typing.LiteralString` 标注任意的字面量字符串类型

<details>
<summary>Example</summary>

```python
def run_query(sql: LiteralString) -> ...
    ...

def caller(
    arbitrary_string: str,
    query_string: LiteralString,
    table_name: LiteralString,
) -> None:
    run_query("SELECT * FROM students")       # ok
    run_query(query_string)                   # ok
    run_query("SELECT * FROM " + table_name)  # ok
    run_query(arbitrary_string)               # type checker error
    run_query(                                # type checker error
        f"SELECT * FROM students WHERE name = {arbitrary_string}"
    )
```

</details>

## Trivial

### PEP654: Exception Groups and except*

支持嵌套的异常组并支持在捕获异常时提取组内的异常多次处理

<details>
<summary>Example</summary>

```python
from builtins import ExceptionGroup

def test():
    raise ExceptionGroup(
        "Multiple errors",
        [
            ValueError("Invalid value"),
            ExceptionGroup(
                "Nested group",
                [
                    ImportError("No module found"),
                    ModuleNotFoundError("Another module missing")
                ]
            ),
            TypeError("Wrong type")
        ]
    )

try:
    test()
except* ValueError as e:
    print("Caught ValueError:", e)
except* ImportError as e:
    print("Caught ImportError:", e)
```

### indows py.exe launcher improvements

> The copy of the Python Install Manager included with Python 3.11 has been significantly updated. It now supports company/tag syntax as defined in PEP 514 using the -V:<company>/<tag> argument instead of the limited -<major>.<minor>. This allows launching distributions other than PythonCore, the one hosted on python.org.

</details>

### Type Hints

#### PEP 681: Data class transforms

为静态类型检查器标识某个类支持数据类的特点, 以自动推断使用.

<details>
<summary>Example</summary>

```python
from typing import dataclass_transform

@dataclass_transform()
def my_dataclass(cls):
    return cls

@my_dataclass
class Point:
    x: int
    y: int

p = Point()
p.x = 10
p.y = 20

print(p.x, p.y)
```

</details>

## 总结

1. 说是比 3.10 平均快了 1.25 倍
2. 异常打印更友好了
3. 异常捕获时可以通过`add_note`添加关于上下文的注释, 对于异常信息回溯处理更灵活
